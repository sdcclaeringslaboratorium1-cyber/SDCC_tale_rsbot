<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8">
  <title>Chat med Mogens</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h1>Chat med Mogens TEST</h1>
  <h3>
    Mogens er 77 og har haft diabetes i 20 år.<br>
    Han har med en langtidsblodsukkermåling konstateret for højt blodsukkerniveau.<br>
    Din opgave er at tage en faglig snak med Mogens om opstart på insulinbehandling.
  </h3>
  <input type="text" id="prompt" placeholder="Skriv besked..." />
  <button onclick="sendMessage()">Send</button>
  <pre id="response"></pre>
  <audio id="audioPlayer" controls style="display:none;"></audio>

  <div id="adviceBox">
  <h1>5 råd til en god patientsamtale</h1>
  <ol>
    <li>Start med nærvær og klar rammesætning</li>
    <li>Lyt aktivt og stil åbne spørgsmål</li>
    <li>Vis empati og anerkend patientens perspektiv</li>
    <li>Opsummer og afstem forståelsen undervejs</li>
    <li>Afslut med klare aftaler og mulighed for spørgsmål</li>
  </ol>
</div>
  <script>
    let dialog = [];

    document.getElementById('prompt').addEventListener('keydown', function(event) {
      if (event.key === 'Enter') {
        sendMessage();
      }
    });

    async function sendMessage() {
      const promptInput = document.getElementById('prompt');
      const userMessage = promptInput.value.trim();
      if (!userMessage) return;

      // Tilføj brugerens besked til dialogen
      dialog.push({ sender: "Dig", text: userMessage });

      document.getElementById('response').innerText = dialog
        .slice().reverse()
        .map(msg => `${msg.sender}: ${msg.text}`)
        .join('\n\n');

      // Send besked til backend (OpenAI)
      const res = await fetch('http://localhost:3000/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: userMessage, dialog })
      });
      const data = await res.json();
      const mogensReply = data.reply || "Ingen svar fra Mogens.";

      // Afspil svaret med ElevenLabs og tilføj til dialogen når lyden starter
      await speakWithElevenLabsOnPlay(mogensReply);

      // Tøm inputfeltet
      promptInput.value = "";
    }

    // Funktion der afspiller ElevenLabs-lyd og tilføjer til dialogen når lyden starter
    async function speakWithElevenLabsOnPlay(text) {
      const res = await fetch('http://localhost:3000/api/speak', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text })
      });
      if (res.ok) {
        const audioBlob = await res.blob();
        const audioUrl = URL.createObjectURL(audioBlob);
        const audioPlayer = document.getElementById('audioPlayer');
        audioPlayer.src = audioUrl;
        audioPlayer.style.display = "block";
        audioPlayer.onplay = function() {
          dialog.push({ sender: "Mogens", text: text });
          document.getElementById('response').innerText = dialog
            .slice().reverse()
            .map(msg => `${msg.sender}: ${msg.text}`)
            .join('\n\n');
          audioPlayer.onplay = null;
        };
        audioPlayer.play();
      } else {
        document.getElementById('response').innerText += "\n(Kunne ikke hente lyd fra ElevenLabs)";
      }
    }
  </script>
</body>
</html>